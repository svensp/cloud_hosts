---
- name: python3-lxml
  apt: 
    name: python3-lxml
    state: present
  tags: ['cluster', 'stonith', 'hetzner']
- name: python3-pip
  apt: 
    name: python3-pip
    state: present
  tags: ['cluster', 'stonith', 'hetzner']
- name:
  pip:
    executable: pip3
    name: hetznercloud
    state: latest
  tags: ['cluster', 'stonith', 'hetzner']
- name: Install Hetzner Cloud STONITH resource
  copy: 
    src: hetzner_cloud
    dest: /usr/lib/stonith/plugins/external/
    mode: 0755
  tags: ['cluster', 'stonith', 'hetzner']
- name: Create STONITH devices
  pcs_resource:
    name: "STONITH"
    state: present
    resource_type: "stonith:external/hetzner_cloud"
    options: "api_token={{ api_token }} op monitor timeout=60s on-fail={{ on_fail }} interval=30s meta failure-timeout=60 --clone"
  run_once: true
  tags: ['cluster', 'stonith', 'hetzner']
- name: Remove non-clone STONITH devices
  pcs_resource:
    name: "STONITH_{{ ansible_hostname }}"
    state: absent
  tags: ['cluster', 'stonith', 'hetzner']
  throttle: 1
- name: wait for resources to be created
  pause:
    seconds: 1
  tags: ['cluster_drbd', 'pcs', 'pcs-resource']
